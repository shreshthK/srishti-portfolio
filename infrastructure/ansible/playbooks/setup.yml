# ============================================================================
# MAIN SETUP PLAYBOOK
# ============================================================================
# This playbook configures a fresh EC2 instance to run the portfolio app.
# It applies all necessary roles in the correct order.
#
# Prerequisites:
# - Terraform has created the EC2 instance
# - EC2 instance is accessible via SSH
# - AWS credentials are configured
#
# Usage:
#   cd infrastructure/ansible
#   ansible-playbook playbooks/setup.yml
#
# Learning Resources:
# - Ansible Playbooks: https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html
# - Ansible Roles: https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html
# ============================================================================

---
- name: Configure Portfolio Server
  hosts: portfolio_servers
  become: true  # Run as root (sudo)

  # --------------------------------------------------------------------------
  # Variables
  # --------------------------------------------------------------------------
  # These can be overridden in inventory or via command line (-e "var=value")
  vars:
    # Application settings
    app_name: portfolio
    app_port: 3000

    # Docker settings
    docker_compose_version: "2.24.0"

    # Nginx settings
    nginx_worker_processes: auto
    nginx_worker_connections: 1024

    # Domain settings (optional)
    domain_name: ""  # TODO: Set your domain if applicable

    # ECR settings (populated from inventory or command line)
    # ecr_repository_url: "{{ lookup('env', 'ECR_REPOSITORY_URL') }}"

  # --------------------------------------------------------------------------
  # Pre-Tasks
  # --------------------------------------------------------------------------
  # Tasks that run before roles
  pre_tasks:
    - name: Gather facts
      ansible.builtin.setup:
        gather_subset:
          - min
          - hardware

    - name: Update system packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: true
      register: system_update

    - name: Reboot if kernel was updated
      ansible.builtin.reboot:
        msg: "Rebooting due to kernel update"
        reboot_timeout: 300
      when: system_update.changed and 'kernel' in (system_update.results | default([]) | map(attribute='name') | list | join(' '))

    - name: Display connection info
      ansible.builtin.debug:
        msg: "Connected to {{ inventory_hostname }} ({{ ansible_host }})"

  # --------------------------------------------------------------------------
  # Roles
  # --------------------------------------------------------------------------
  # Roles are applied in order
  roles:
    - role: docker
      tags: [docker, setup]

    - role: nginx
      tags: [nginx, setup]

    - role: cloudwatch
      tags: [cloudwatch, monitoring, setup]

    - role: app
      tags: [app, deploy]

  # --------------------------------------------------------------------------
  # Post-Tasks
  # --------------------------------------------------------------------------
  # Tasks that run after all roles
  post_tasks:
    - name: Verify Docker is running
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true

    - name: Verify Nginx is running
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: true

    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          ========================================
          Server configuration complete!
          ========================================

          EC2 Instance: {{ inventory_hostname }}
          Public IP: {{ ansible_host }}

          Next steps:
          1. Build and push Docker image to ECR
          2. Deploy with: ansible-playbook playbooks/deploy.yml

          Or deploy from GitHub Actions!
          ========================================

  # --------------------------------------------------------------------------
  # Handlers
  # --------------------------------------------------------------------------
  # Handlers are triggered by 'notify' in tasks
  handlers:
    - name: Restart Docker
      ansible.builtin.systemd:
        name: docker
        state: restarted
        daemon_reload: true

    - name: Restart Nginx
      ansible.builtin.systemd:
        name: nginx
        state: restarted

    - name: Reload Nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded
