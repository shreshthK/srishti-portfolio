# ============================================================================
# DEPLOYMENT PLAYBOOK
# ============================================================================
# This playbook deploys a new version of the portfolio application.
# It pulls the latest Docker image from ECR and restarts the container.
#
# Prerequisites:
# - EC2 instance is configured (setup.yml has been run)
# - Docker image has been pushed to ECR
#
# Usage:
#   # Deploy latest tag
#   ansible-playbook playbooks/deploy.yml
#
#   # Deploy specific version
#   ansible-playbook playbooks/deploy.yml -e "image_tag=abc123"
#
#   # Deploy with ECR URL specified
#   ansible-playbook playbooks/deploy.yml -e "ecr_repository_url=123456.dkr.ecr.us-east-1.amazonaws.com/portfolio-prod-app"
#
# Learning Resources:
# - Ansible Docker Collection: https://docs.ansible.com/ansible/latest/collections/community/docker/
# ============================================================================

---
- name: Deploy Portfolio Application
  hosts: portfolio_servers
  become: true

  # --------------------------------------------------------------------------
  # Variables
  # --------------------------------------------------------------------------
  vars:
    # Container settings
    app_name: portfolio
    container_name: portfolio
    container_port: 80
    host_port: 3000

    # Image settings
    # TODO: These should be passed in via -e or inventory
    ecr_repository_url: "{{ lookup('env', 'ECR_REPOSITORY_URL') | default('') }}"
    image_tag: "{{ lookup('env', 'IMAGE_TAG') | default('latest') }}"

    # Health check settings
    health_check_path: /health
    health_check_timeout: 60
    health_check_interval: 5

  # --------------------------------------------------------------------------
  # Pre-Flight Checks
  # --------------------------------------------------------------------------
  pre_tasks:
    - name: Validate ECR repository URL is set
      ansible.builtin.assert:
        that:
          - ecr_repository_url | length > 0
        fail_msg: "ECR repository URL must be set. Use -e 'ecr_repository_url=...'"
        success_msg: "Deploying from {{ ecr_repository_url }}"

    - name: Display deployment info
      ansible.builtin.debug:
        msg: |
          ========================================
          Starting Deployment
          ========================================
          Host: {{ inventory_hostname }} ({{ ansible_host }})
          Image: {{ ecr_repository_url }}:{{ image_tag }}
          ========================================

  # --------------------------------------------------------------------------
  # Deployment Tasks
  # --------------------------------------------------------------------------
  tasks:
    # Step 1: Login to ECR
    - name: Get ECR login password
      ansible.builtin.command:
        cmd: aws ecr get-login-password --region {{ aws_region | default('us-east-1') }}
      register: ecr_password
      changed_when: false
      no_log: true  # Don't log the password

    - name: Login to ECR
      community.docker.docker_login:
        registry_url: "{{ ecr_repository_url | regex_replace('/.*$', '') }}"
        username: AWS
        password: "{{ ecr_password.stdout }}"
        reauthorize: true

    # Step 2: Pull the new image
    - name: Pull Docker image from ECR
      community.docker.docker_image:
        name: "{{ ecr_repository_url }}"
        tag: "{{ image_tag }}"
        source: pull
        force_source: true
      register: image_pull

    - name: Display pull result
      ansible.builtin.debug:
        msg: "Image {{ 'pulled' if image_pull.changed else 'already present' }}: {{ ecr_repository_url }}:{{ image_tag }}"

    # Step 3: Stop existing container
    - name: Stop existing container (if running)
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: stopped
      ignore_errors: true
      register: stop_result

    - name: Remove existing container
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: absent
      ignore_errors: true

    # Step 4: Start new container
    - name: Start new container
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ ecr_repository_url }}:{{ image_tag }}"
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ host_port }}:{{ container_port }}"
        # Health check
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost:{{ container_port }}{{ health_check_path }}"]
          interval: 30s
          timeout: 10s
          retries: 3
          start_period: 10s
        # Logging configuration
        log_driver: json-file
        log_options:
          max-size: "10m"
          max-file: "3"
      register: container_start

    # Step 5: Wait for container to be healthy
    - name: Wait for container to be healthy
      ansible.builtin.uri:
        url: "http://localhost:{{ host_port }}{{ health_check_path }}"
        method: GET
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: "{{ (health_check_timeout / health_check_interval) | int }}"
      delay: "{{ health_check_interval }}"

    # Step 6: Verify Nginx can reach the container
    - name: Verify Nginx proxy
      ansible.builtin.uri:
        url: "http://localhost:80{{ health_check_path }}"
        method: GET
        status_code: 200
      register: nginx_check
      until: nginx_check.status == 200
      retries: 5
      delay: 2

    # Step 7: Cleanup old images
    - name: Clean up dangling images
      community.docker.docker_prune:
        images: true
        images_filters:
          dangling: true

  # --------------------------------------------------------------------------
  # Post-Deployment
  # --------------------------------------------------------------------------
  post_tasks:
    - name: Get container info
      community.docker.docker_container_info:
        name: "{{ container_name }}"
      register: container_info

    - name: Display deployment result
      ansible.builtin.debug:
        msg: |
          ========================================
          Deployment Complete!
          ========================================
          Container: {{ container_name }}
          Image: {{ ecr_repository_url }}:{{ image_tag }}
          Status: {{ container_info.container.State.Status }}
          Health: {{ container_info.container.State.Health.Status | default('N/A') }}

          URLs:
          - Local: http://localhost:{{ host_port }}
          - Nginx: http://{{ ansible_host }}
          ========================================

  # --------------------------------------------------------------------------
  # Handlers
  # --------------------------------------------------------------------------
  handlers:
    - name: Reload Nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded
