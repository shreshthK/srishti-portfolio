#!/bin/bash
# ECR Login Script
# Generated by Ansible - Do not edit manually

set -e

AWS_REGION="{{ aws_region | default('us-east-1') }}"
ECR_REGISTRY="{{ ecr_repository_url | default('') | regex_replace('/.*$', '') }}"

if [ -z "$ECR_REGISTRY" ]; then
    # Get the registry URL from instance metadata
    ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
    ECR_REGISTRY="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
fi

echo "Logging into ECR: $ECR_REGISTRY"
aws ecr get-login-password --region "$AWS_REGION" | \
    docker login --username AWS --password-stdin "$ECR_REGISTRY"

echo "ECR login successful"
