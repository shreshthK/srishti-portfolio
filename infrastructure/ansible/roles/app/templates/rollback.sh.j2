#!/bin/bash
# ============================================================================
# ROLLBACK SCRIPT
# ============================================================================
# Generated by Ansible - Do not edit manually
#
# Rolls back to the previous deployment if available.
# ============================================================================

set -e

CONTAINER_NAME="{{ app_name | default('portfolio') }}"
HOST_PORT="{{ app_port | default(3000) }}"
CONTAINER_PORT="80"
BACKUP_DIR="/opt/portfolio/backups"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}========================================${NC}"
echo -e "${YELLOW}Portfolio Rollback${NC}"
echo -e "${YELLOW}========================================${NC}"

# Check if backup exists
if [ ! -f "$BACKUP_DIR/last_image.txt" ]; then
    echo -e "${RED}Error: No backup image found${NC}"
    echo "Cannot rollback without a previous deployment"
    exit 1
fi

PREVIOUS_IMAGE=$(cat "$BACKUP_DIR/last_image.txt")

if [ "$PREVIOUS_IMAGE" == "none" ] || [ -z "$PREVIOUS_IMAGE" ]; then
    echo -e "${RED}Error: No valid previous image found${NC}"
    exit 1
fi

echo "Rolling back to: $PREVIOUS_IMAGE"

# Stop current container
echo -e "${YELLOW}Stopping current container...${NC}"
docker stop $CONTAINER_NAME 2>/dev/null || true
docker rm $CONTAINER_NAME 2>/dev/null || true

# Start with previous image
echo -e "${YELLOW}Starting previous version...${NC}"
docker run -d \
    --name $CONTAINER_NAME \
    --restart unless-stopped \
    -p $HOST_PORT:$CONTAINER_PORT \
    --health-cmd="curl -f http://localhost:$CONTAINER_PORT/health || exit 1" \
    --health-interval=30s \
    --health-timeout=10s \
    --health-retries=3 \
    --health-start-period=10s \
    "$PREVIOUS_IMAGE"

# Wait for health check
echo -e "${YELLOW}Waiting for health check...${NC}"
sleep 10

if curl -sf "http://localhost:$HOST_PORT/health" > /dev/null 2>&1; then
    echo -e "${GREEN}Rollback successful!${NC}"
    docker ps | grep $CONTAINER_NAME
else
    echo -e "${RED}Rollback may have failed - please check container status${NC}"
    docker logs $CONTAINER_NAME --tail 50
    exit 1
fi
