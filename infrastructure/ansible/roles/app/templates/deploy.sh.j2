#!/bin/bash
# ============================================================================
# DEPLOYMENT SCRIPT
# ============================================================================
# Generated by Ansible - Do not edit manually
#
# Usage:
#   ./deploy.sh                 # Deploy latest tag
#   ./deploy.sh abc123         # Deploy specific tag
# ============================================================================

set -e

# Configuration
CONTAINER_NAME="{{ app_name | default('portfolio') }}"
ECR_REPO="{{ ecr_repository_url | default('') }}"
AWS_REGION="{{ aws_region | default('us-east-1') }}"
HOST_PORT="{{ app_port | default(3000) }}"
CONTAINER_PORT="80"
HEALTH_CHECK_PATH="/health"
HEALTH_CHECK_TIMEOUT=60

# Image tag (default to 'latest')
IMAGE_TAG="${1:-latest}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Portfolio Deployment${NC}"
echo -e "${GREEN}========================================${NC}"
echo "Container: $CONTAINER_NAME"
echo "Image: $ECR_REPO:$IMAGE_TAG"
echo "Host Port: $HOST_PORT"
echo ""

# Check if ECR_REPO is set
if [ -z "$ECR_REPO" ]; then
    echo -e "${RED}Error: ECR_REPO is not set${NC}"
    echo "Set it in the Ansible inventory or pass it as an environment variable"
    exit 1
fi

# Step 1: Login to ECR
echo -e "${YELLOW}Step 1: Logging into ECR...${NC}"
/usr/local/bin/ecr-login.sh || {
    echo -e "${RED}ECR login failed${NC}"
    exit 1
}

# Step 2: Pull the image
echo -e "${YELLOW}Step 2: Pulling image...${NC}"
docker pull "$ECR_REPO:$IMAGE_TAG" || {
    echo -e "${RED}Failed to pull image${NC}"
    exit 1
}

# Step 3: Backup current container ID (for rollback)
echo -e "${YELLOW}Step 3: Backing up current state...${NC}"
CURRENT_IMAGE=$(docker inspect --format='{{ '{{' }}.Image{{ '}}' }}' $CONTAINER_NAME 2>/dev/null || echo "none")
echo "$CURRENT_IMAGE" > /opt/portfolio/backups/last_image.txt
date +%s > /opt/portfolio/backups/last_deploy.txt

# Step 4: Stop and remove existing container
echo -e "${YELLOW}Step 4: Stopping existing container...${NC}"
docker stop $CONTAINER_NAME 2>/dev/null || true
docker rm $CONTAINER_NAME 2>/dev/null || true

# Step 5: Start new container
echo -e "${YELLOW}Step 5: Starting new container...${NC}"
docker run -d \
    --name $CONTAINER_NAME \
    --restart unless-stopped \
    -p $HOST_PORT:$CONTAINER_PORT \
    --health-cmd="curl -f http://localhost:$CONTAINER_PORT$HEALTH_CHECK_PATH || exit 1" \
    --health-interval=30s \
    --health-timeout=10s \
    --health-retries=3 \
    --health-start-period=10s \
    --log-driver json-file \
    --log-opt max-size=10m \
    --log-opt max-file=3 \
    "$ECR_REPO:$IMAGE_TAG" || {
    echo -e "${RED}Failed to start container${NC}"
    exit 1
}

# Step 6: Wait for health check
echo -e "${YELLOW}Step 6: Waiting for health check...${NC}"
ELAPSED=0
while [ $ELAPSED -lt $HEALTH_CHECK_TIMEOUT ]; do
    if curl -sf "http://localhost:$HOST_PORT$HEALTH_CHECK_PATH" > /dev/null 2>&1; then
        echo -e "${GREEN}Health check passed!${NC}"
        break
    fi
    echo "  Waiting... ($ELAPSED seconds)"
    sleep 5
    ELAPSED=$((ELAPSED + 5))
done

if [ $ELAPSED -ge $HEALTH_CHECK_TIMEOUT ]; then
    echo -e "${RED}Health check timed out!${NC}"
    echo "Rolling back to previous version..."
    /opt/portfolio/scripts/rollback.sh
    exit 1
fi

# Step 7: Verify via Nginx
echo -e "${YELLOW}Step 7: Verifying Nginx proxy...${NC}"
if curl -sf "http://localhost:80$HEALTH_CHECK_PATH" > /dev/null 2>&1; then
    echo -e "${GREEN}Nginx proxy working!${NC}"
else
    echo -e "${YELLOW}Warning: Nginx proxy check failed (may need to check Nginx config)${NC}"
fi

# Step 8: Clean up old images
echo -e "${YELLOW}Step 8: Cleaning up old images...${NC}"
docker image prune -f

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Deployment Complete!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
docker ps | grep $CONTAINER_NAME
echo ""
echo "Site should be available at:"
echo "  - http://localhost:$HOST_PORT"
echo "  - http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo 'YOUR_IP')"
